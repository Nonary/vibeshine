<!DOCTYPE html>
<html lang="en" data-bs-theme="auto">

<head>
      <%- header %>
      <style>
        .precmd-head {
          width: 200px;
        }

        .monospace {
          font-family: monospace;
        }

        .cover-finder {}

        .cover-finder .cover-results {
          max-height: 400px;
          overflow-x: hidden;
          overflow-y: auto;
        }

        .cover-finder .cover-results.busy * {
          cursor: wait !important;
          pointer-events: none;
        }

        .cover-container {
          padding-top: 133.33%;
          position: relative;
        }

        .cover-container.result {
          cursor: pointer;
        }

        .spinner-border {
          position: absolute;
          left: 0;
          top: 0;
          right: 0;
          bottom: 0;
          margin: auto;
        }

        .cover-container img {
          display: block;
          position: absolute;
          top: 0;
          width: 100%;
          height: 100%;
          object-fit: cover;
        }

        .config-page {
          padding: 1em;
          border: 1px solid #dee2e6;
          border-top: none;
        }

        td {
          padding: 0 0.5em;
        }

        .env-table td {
          padding: 0.25em;
          border-bottom: rgba(0, 0, 0, 0.25) 1px solid;
          vertical-align: top;
        }
      </style>
</head>

<body id="app" v-cloak>
  <Navbar></Navbar>
  <div class="container">
    <div class="my-4">
      <h1>{{ $t('apps.applications_title') }}</h1>
      <div>{{ $t('apps.applications_desc') }}</div>
    </div>
    <div class="card p-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div></div>
        <div>
          <button class="btn btn-danger me-2" v-if="platform === 'windows' && playniteEnabled" @click="purgeAutoSync()">
            <i class="fas fa-trash"></i> {{ $t('apps.delete_all_autosync') || 'Delete All Playnite Auto-Sync Apps' }}
          </button>
          <button class="btn btn-secondary" v-if="platform === 'windows' && playniteEnabled" @click="forceSync" :disabled="syncBusy">
            <span v-if="syncBusy" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            {{ $t('playnite.force_sync') || 'Force Sync Now' }}
          </button>
          <button class="btn btn-outline-secondary" v-if="platform === 'windows' && !playniteEnabled" @click="gotoPlaynite">
            <i class="fas fa-plug"></i> {{ $t('playnite.setup_integration') || 'Setup Playnite Integration' }}
          </button>
        </div>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th scope="col">{{ $t('apps.name') }}</th>
            <th scope="col">{{ $t('apps.actions') }}</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(app,i) in apps" :key="i">
            <td>
              {{app.name}}
              <span v-if="app['playnite-id']" class="badge bg-info text-dark ms-2">{{ $t('apps.playnite_badge') }}</span>
              <small v-if="app['playnite-id']" class="text-muted ms-2">
                <template v-if="app['playnite-managed'] === 'manual'">{{ $t('apps.playnite_manual') }}</template>
                <template v-else>
                  <template v-if="(app['playnite-source']||'') === 'recent'">{{ $t('apps.playnite_source_recent') }}</template>
                  <template v-else-if="(app['playnite-source']||'') === 'category'">{{ $t('apps.playnite_source_category') }}</template>
                  <template v-else-if="(app['playnite-source']||'') === 'recent+category'">{{ $t('apps.playnite_source_both') }}</template>
                  <template v-else>{{ $t('apps.playnite_source_unknown') }}</template>
                </template>
              </small>
            </td>
            <td>
              <button class="btn btn-primary mx-1" @click="editApp(i)">
                <i class="fas fa-edit"></i> {{ $t('apps.edit') }}
              </button>
              <button class="btn btn-danger mx-1" @click="showDeleteForm(i)">
                <i class="fas fa-trash"></i> {{ $t('apps.delete') }}
              </button>
              <template v-if="app['playnite-id']">
                <button class="btn btn-warning mx-1" v-if="!isExcluded(app)" @click="toggleExclude(i)">
                  <i class="fas fa-ban"></i> {{ $t('apps.exclude_from_autosync') || 'Exclude from auto-sync' }}
                </button>
                <button class="btn btn-success mx-1" v-else @click="toggleExclude(i)">
                  <i class="fas fa-undo"></i> {{ $t('apps.remove_exclusion') || 'Remove exclusion' }}
                </button>
              </template>
              
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="edit-form card mt-2" v-if="showEditForm">
      <div class="p-4">
        <!-- Playnite-managed notice -->
        <div class="alert alert-info" v-if="editForm && editForm['playnite-id']">
          <span class="badge bg-info text-dark me-2">{{ $t('apps.playnite_badge') }}</span>
          {{ $t('apps.playnite_edit_notice') }}
        </div>
        <!-- Application Name + Playnite typeahead (Windows) -->
        <div class="mb-3 position-relative">
          <label for="appName" class="form-label">
            {{ $t('apps.app_name') }}
            <span v-if="editForm && editForm['playnite-id']" class="badge bg-info text-dark ms-2">{{ $t('apps.playnite_badge') }}</span>
          </label>
          <input
            type="text"
            class="form-control"
            id="appName"
            aria-describedby="appNameHelp"
            v-model="editForm.name"
            @focus="onNameFocus"
            @input="maybeShowNameSuggestions"
            @blur="hideNameSuggestions"
            :disabled="!!editForm['playnite-id']"
          />
          <div id="appNameHelp" class="form-text">{{ $t('apps.app_name_desc') }}</div>

          <!-- Inline Playnite suggestions dropdown -->
          <div
            v-if="platform === 'windows' && showNameSuggestions && !editForm['playnite-id']"
            class="card position-absolute w-100 mt-1"
            style="z-index: 1000;"
          >
            <div class="card-body p-2">
              <div class="list-group" style="max-height: 240px; overflow-y: auto;">
                <div v-if="nameSuggestions.length === 0" class="text-muted small px-2 py-1">{{ $t('apps.add_playnite_search') || 'Search Playnite games...' }}</div>
                <button
                  v-for="g in nameSuggestions"
                  :key="g.id"
                  class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                  @click="selectPlayniteGame(g)"
                >
                  <span>
                    {{ g.name }}
                  </span>
                  <span class="d-flex align-items-center">
                    <span class="badge bg-success">{{ 'Installed' }}</span>
                    <small class="text-muted ms-2">{{ (g.categories||[]).join('; ') }}</small>
                  </span>
                </button>
              </div>
            </div>
          </div>
        </div>
        <!-- output -->
        <div class="mb-3">
          <label for="appOutput" class="form-label">{{ $t('apps.output_name') }}</label>
          <input type="text" class="form-control monospace" id="appOutput" aria-describedby="appOutputHelp"
            v-model="editForm.output" :disabled="!!editForm['playnite-id']" />
          <div id="appOutputHelp" class="form-text">{{ $t('apps.output_desc') }}</div>
        </div>
        <!-- prep-cmd -->
        <Checkbox class="mb-3"
                  id="excludeGlobalPrep"
                  label="apps.global_prep_name"
                  desc="apps.global_prep_desc"
                  v-model="editForm['exclude-global-prep-cmd']"
                  default="true"
                  inverse-values
        ></Checkbox>
        <div class="mb-3">
          <label for="appName" class="form-label">{{ $t('apps.cmd_prep_name') }}</label>
          <div class="form-text">{{ $t('apps.cmd_prep_desc') }}</div>
          <div class="d-flex justify-content-start mb-3 mt-3" v-if="editForm['prep-cmd'].length === 0">
            <button class="btn btn-success" @click="addPrepCmd">
              <i class="fas fa-plus mr-1"></i> {{ $t('apps.add_cmds') }}
            </button>
          </div>
          <table class="table" v-if="editForm['prep-cmd'].length > 0">
            <thead>
              <tr>
                <th scope="col"><i class="fas fa-play"></i> {{ $t('_common.do_cmd') }}</th>
                <th scope="col"><i class="fas fa-undo"></i> {{ $t('_common.undo_cmd') }}</th>
                <th scope="col" v-if="platform === 'windows'">
                  <i class="fas fa-shield-alt"></i> {{ $t('_common.run_as') }}
                </th>
                <th scope="col"></th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="(c, i) in editForm['prep-cmd']">
                <td>
                  <input type="text" class="form-control monospace" v-model="c.do" />
                </td>
                <td>
                  <input type="text" class="form-control monospace" v-model="c.undo" />
                </td>
                <td v-if="platform === 'windows'" class="align-middle">
                  <Checkbox :id="'prep-cmd-admin-' + i"
                            label="_common.elevated"
                            desc=""
                            v-model="c.elevated"
                  ></Checkbox>
                </td>
                <td>
                  <button class="btn btn-danger" @click="editForm['prep-cmd'].splice(i,1)">
                    <i class="fas fa-trash"></i>
                  </button>
                  <button class="btn btn-success" @click="addPrepCmd">
                    <i class="fas fa-plus"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- detached -->
        <div class="mb-3">
          <label for="appName" class="form-label">{{ $t('apps.detached_cmds') }}</label>
          <div v-for="(c,i) in editForm.detached" class="d-flex justify-content-between my-2">
            <input type="text" v-model="editForm.detached[i]" class="form-control monospace" :disabled="!!editForm['playnite-id']">
            <button class="btn btn-danger mx-2" @click="editForm.detached.splice(i,1)" :disabled="!!editForm['playnite-id']">
              &times;
            </button>
          </div>
          <div class="d-flex justify-content-between">
            <button class="btn btn-success" @click="editForm.detached.push('');" :disabled="!!editForm['playnite-id']">
              <i class="fas fa-plus mr-1"></i> {{ $t('apps.detached_cmds_add') }}
            </button>
          </div>
          <div class="form-text">
            {{ $t('apps.detached_cmds_desc') }}<br>
            <b>{{ $t('_common.note') }}</b> {{ $t('apps.detached_cmds_note') }}
          </div>
        </div>
        <!-- command -->
        <div class="mb-3">
          <label for="appCmd" class="form-label">{{ $t('apps.cmd') }}</label>
          <input type="text" class="form-control monospace" id="appCmd" aria-describedby="appCmdHelp"
            v-model="editForm.cmd" :disabled="!!editForm['playnite-id']" />
          <div id="appCmdHelp" class="form-text">
            {{ $t('apps.cmd_desc') }}<br>
            <b>{{ $t('_common.note') }}</b> {{ $t('apps.cmd_note') }}
          </div>
        </div>
        <!-- working dir -->
        <div class="mb-3">
          <label for="appWorkingDir" class="form-label">{{ $t('apps.working_dir') }}</label>
          <input type="text" class="form-control monospace" id="appWorkingDir" aria-describedby="appWorkingDirHelp"
            v-model="editForm['working-dir']" :disabled="!!editForm['playnite-id']" />
          <div id="appWorkingDirHelp" class="form-text">{{ $t('apps.working_dir_desc') }}</div>
        </div>
        <!-- elevation -->
        <Checkbox v-if="platform === 'windows'"
                  class="mb-3"
                  id="appElevation"
                  label="_common.run_as"
                  desc="apps.run_as_desc"
                  v-model="editForm.elevated"
                  :disabled="!!editForm['playnite-id']"
                  default="false"
        ></Checkbox>
        <!-- auto-detach -->
        <Checkbox class="mb-3"
                  id="autoDetach"
                  label="apps.auto_detach"
                  desc="apps.auto_detach_desc"
                  v-model="editForm['auto-detach']"
                  :disabled="!!editForm['playnite-id']"
                  default="true"
        ></Checkbox>
        <!-- wait for all processes -->
        <Checkbox class="mb-3"
                  id="waitAll"
                  label="apps.wait_all"
                  desc="apps.wait_all_desc"
                  v-model="editForm['wait-all']"
                  :disabled="!!editForm['playnite-id']"
                  default="true"
        ></Checkbox>
        <!-- exit timeout -->
        <div class="mb-3">
          <label for="exitTimeout" class="form-label">{{ $t('apps.exit_timeout') }}</label>
          <input type="number" class="form-control monospace" id="exitTimeout" aria-describedby="exitTimeoutHelp"
                 v-model="editForm['exit-timeout']" min="0" placeholder="5" :disabled="!!editForm['playnite-id']" />
          <div id="exitTimeoutHelp" class="form-text">{{ $t('apps.exit_timeout_desc') }}</div>
        </div>
        <div class="mb-3">
          <label for="appImagePath" class="form-label">{{ $t('apps.image') }}</label>
          <div class="input-group dropup">
            <input type="text" class="form-control monospace" id="appImagePath" aria-describedby="appImagePathHelp"
              v-model="editForm['image-path']" :disabled="!!editForm['playnite-id']" />
            <button class="btn btn-secondary dropdown-toggle" type="button" id="findCoverToggle"
              aria-expanded="false" @click="showCoverFinder" ref="coverFinderDropdown" :disabled="!!editForm['playnite-id']">
              {{ $t('apps.find_cover') }}
            </button>
            <div class="dropdown-menu dropdown-menu-end w-50 cover-finder overflow-hidden"
              aria-labelledby="findCoverToggle">
              <div class="modal-header px-2">
                <h4 class="modal-title">{{ $t('apps.covers_found') }}</h4>
                <button type="button" class="btn-close mr-2" aria-label="Close" @click="closeCoverFinder"></button>
              </div>
              <div class="modal-body cover-results px-3 pt-3" :class="{ busy: coverFinderBusy }">
                <div class="row">
                  <div v-if="coverSearching" class="col-12 col-sm-6 col-lg-4 mb-3">
                    <div class="cover-container">
                      <div class="spinner-border" role="status">
                        <span class="visually-hidden">{{ $t('apps.loading') }}</span>
                      </div>
                    </div>
                  </div>
                  <div v-for="(cover,i) in coverCandidates" :key="'i'" class="col-12 col-sm-6 col-lg-4 mb-3"
                    @click="useCover(cover)">
                    <div class="cover-container result">
                      <img class="rounded" :src="cover.url" />
                    </div>
                    <label class="d-block text-nowrap text-center text-truncate">
                      {{cover.name}}
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div id="appImagePathHelp" class="form-text">{{ $t('apps.image_desc') }}</div>
        </div>
        <div class="env-hint alert alert-info">
          <div class="form-text">
            <h4>{{ $t('apps.env_vars_about') }}</h4>
            {{ $t('apps.env_vars_desc') }}
          </div>
          <table class="env-table">
            <tr>
              <td><b>{{ $t('apps.env_var_name') }}</b></td>
              <td><b></b></td>
            </tr>
            <tr>
              <td style="font-family: monospace">SUNSHINE_APP_ID</td>
              <td>{{ $t('apps.env_app_id') }}</td>
            </tr>
            <tr>
              <td style="font-family: monospace">SUNSHINE_APP_NAME</td>
              <td>{{ $t('apps.env_app_name') }}</td>
            </tr>
            <tr>
              <td style="font-family: monospace">SUNSHINE_CLIENT_WIDTH</td>
              <td>{{ $t('apps.env_client_width') }}</td>
            </tr>
            <tr>
              <td style="font-family: monospace">SUNSHINE_CLIENT_HEIGHT</td>
              <td>{{ $t('apps.env_client_height') }}</td>
            </tr>
            <tr>
              <td style="font-family: monospace">SUNSHINE_CLIENT_FPS</td>
              <td>{{ $t('apps.env_client_fps') }}</td>
            </tr>
            <tr>
              <td style="font-family: monospace">SUNSHINE_CLIENT_HDR</td>
              <td>{{ $t('apps.env_client_hdr') }}</td>
            </tr>
            <tr>
              <td style="font-family: monospace">SUNSHINE_CLIENT_GCMAP</td>
              <td>{{ $t('apps.env_client_gcmap') }}</td>
            </tr>
            <tr>
              <td style="font-family: monospace">SUNSHINE_CLIENT_HOST_AUDIO</td>
              <td>{{ $t('apps.env_client_host_audio') }}</td>
            </tr>
            <tr>
              <td style="font-family: monospace">SUNSHINE_CLIENT_ENABLE_SOPS</td>
              <td>{{ $t('apps.env_client_enable_sops') }}</td>
            </tr>
            <tr>
              <td style="font-family: monospace">SUNSHINE_CLIENT_AUDIO_CONFIGURATION</td>
              <td>{{ $t('apps.env_client_audio_config') }}</td>
            </tr>
          </table>
          <div class="form-text" v-if="platform === 'windows'"><b>{{ $t('apps.env_qres_example') }}</b>
            <pre>cmd /C &lt;{{ $t('apps.env_qres_path') }}&gt;\QRes.exe /X:%SUNSHINE_CLIENT_WIDTH% /Y:%SUNSHINE_CLIENT_HEIGHT% /R:%SUNSHINE_CLIENT_FPS%</pre>
          </div>
          <div class="form-text" v-else-if="platform === 'linux'"><b>{{ $t('apps.env_xrandr_example') }}</b>
            <pre>sh -c "xrandr --output HDMI-1 --mode \"${SUNSHINE_CLIENT_WIDTH}x${SUNSHINE_CLIENT_HEIGHT}\" --rate ${SUNSHINE_CLIENT_FPS}"</pre>
          </div>
          <div class="form-text" v-else-if="platform === 'macos'"><b>{{ $t('apps.env_displayplacer_example') }}</b>
            <pre>sh -c "displayplacer "id:&lt;screenId&gt; res:${SUNSHINE_CLIENT_WIDTH}x${SUNSHINE_CLIENT_HEIGHT} hz:${SUNSHINE_CLIENT_FPS} scaling:on origin:(0,0) degree:0""</pre>
          </div>
          <div class="form-text"><a
              href="https://docs.lizardbyte.dev/projects/sunshine/latest/md_docs_2app__examples.html"
              target="_blank">{{ $t('_common.see_more') }}</a></div>
        </div>
        <!-- Save buttons -->
        <div class="d-flex">
          <button @click="showEditForm = false" class="btn btn-secondary m-2">
            {{ $t('_common.cancel') }}
          </button>
          <button class="btn btn-primary m-2" @click="save">{{ $t('_common.save') }}</button>
        </div>
      </div>
    </div>
    <div class="mt-2" v-else>
      <button class="btn btn-primary me-2" @click="newApp">
        <i class="fas fa-plus"></i> {{ $t('apps.add_new') }}
      </button>
    </div>
  </div>
</body>
<script type="module">
  import { createApp } from 'vue'
  import { initApp } from './init'
  import Navbar from './Navbar.vue'
  import Checkbox from './Checkbox.vue'
  import { Dropdown } from 'bootstrap/dist/js/bootstrap'

  const app = createApp({
    components: {
      Navbar,
      Checkbox
    },
    data() {
      return {
        apps: [],
        showEditForm: false,
        editForm: null,
        playniteGames: [],
        showNameSuggestions: false,
        detachedCmd: "",
        coverSearching: false,
        coverFinderBusy: false,
        coverCandidates: [],
        platform: "",
        playniteEnabled: false,
        syncBusy: false,
        excludedIds: [],
      };
    },
    created() {
      fetch("./api/apps")
        .then((r) => r.json())
        .then((r) => {
          console.log(r);
          this.apps = r.apps;
        });

      fetch("./api/config")
        .then(r => r.json())
        .then(r => {
          this.platform = r.platform;
          const val = (r.playnite_enabled || '').toString().toLowerCase();
          this.playniteEnabled = (val === 'enabled' || val === 'enable' || val === 'true' || val === '1' || val === 'yes' || val === 'on');
          const raw = (r.playnite_exclude_games || '').toString();
          this.excludedIds = raw.split(',').map(s=>s.trim()).filter(Boolean);
        });
    },
    methods: {
      gotoPlaynite() {
        window.location.href = './playnite';
      },
      purgeAutoSync() {
        if (!confirm('Delete all Playnite auto-synced apps?')) return;
        fetch('./api/apps/purge_autosync', { method: 'POST', headers: { 'Content-Type': 'application/json' }})
          .then(r => r.json())
          .then(() => document.location.reload());
      },
      async forceSync() {
        this.syncBusy = true;
        try {
          await fetch('./api/playnite/force_sync', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
          // Refresh list after sync
          const r = await fetch('./api/apps').then(r => r.json());
          this.apps = r.apps || [];
        } catch (e) { console.error(e); }
        this.syncBusy = false;
      },
      isPlayniteAuto(app) {
        return !!app['playnite-id'] && (app['playnite-managed'] !== 'manual');
      },
      isExcluded(app) {
        if (!app || !app['playnite-id']) return false;
        return this.excludedIds.includes(app['playnite-id']);
      },
      async toggleExclude(index) {
        const app = this.apps[index];
        if (!app || !app['playnite-id']) return;
        const id = app['playnite-id'];
        const set = new Set(this.excludedIds);
        const isCurrentlyExcluded = set.has(id);
        if (!isCurrentlyExcluded) {
          const ok = confirm('Are you sure? This will remove it from Applications. You will have to manually add it or remove exclusion from the Playnite tab if you change your mind.');
          if (!ok) return;
        }
        if (isCurrentlyExcluded) set.delete(id); else set.add(id);
        const next = Array.from(set).join(',');
        try {
          await fetch('./api/config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ playnite_exclude_games: next }) });
          if (!isCurrentlyExcluded) {
            // Removing app from Applications immediately when excluding
            try {
              await fetch(`./api/apps/${index}`, { method: 'DELETE', headers: { 'Content-Type': 'application/json' } });
            } catch (e) { console.error(e); }
          }
          // Try to trigger re-sync; ignore errors on non-Windows
          try { await fetch('./api/playnite/force_sync', { method: 'POST', headers: { 'Content-Type': 'application/json' } }); } catch {}
          document.location.reload();
        } catch (e) { console.error(e); }
      },
      newApp() {
        this.editForm = {
          name: "",
          output: "",
          cmd: [],
          index: -1,
          "exclude-global-prep-cmd": false,
          elevated: false,
          "auto-detach": true,
          "wait-all": true,
          "exit-timeout": 5,
          "prep-cmd": [],
          detached: [],
          "image-path": ""
        };
        this.editForm.index = -1;
        this.showEditForm = true;
        this.loadPlayniteGamesIfNeeded();
        this.showNameSuggestions = false;
      },
      loadPlayniteGamesIfNeeded() {
        if (this.platform !== 'windows') return;
        if (!this.playniteGames.length) {
          fetch('./api/playnite/games').then(r => r.json()).then(arr => { this.playniteGames = (arr || []).filter(g => !!g.installed); });
        }
      },
      onNameFocus() {
        this.loadPlayniteGamesIfNeeded();
        if (!this.editForm['playnite-id']) this.showNameSuggestions = true;
      },
      maybeShowNameSuggestions() {
        if (this.platform !== 'windows') return;
        // Show dropdown on input to help discovery
        const q = (this.editForm?.name || '').trim();
        if (!this.playniteGames.length) {
          this.loadPlayniteGamesIfNeeded();
        }
        this.showNameSuggestions = this.playniteGames.length >= 0;
      },
      hideNameSuggestions() {
        // Delay hiding to allow click events on suggestions to register
        setTimeout(() => { this.showNameSuggestions = false; }, 150);
      },
      selectPlayniteGame(g) {
        this.editForm = {
          name: g.name || '',
          output: "",
          cmd: [],
          index: -1,
          "exclude-global-prep-cmd": false,
          elevated: false,
          "auto-detach": true,
          "wait-all": true,
          "exit-timeout": 5,
          "prep-cmd": [],
          detached: [],
          "image-path": "",
          "playnite-id": g.id,
          "playnite-managed": "manual",
        };
        this.showNameSuggestions = false;
        this.showEditForm = true;
      },
      editApp(id) {
        this.editForm = JSON.parse(JSON.stringify(this.apps[id]));
        this.editForm.index = id;
        if (this.editForm["prep-cmd"] === undefined)
          this.editForm["prep-cmd"] = [];
        if (this.editForm["detached"] === undefined)
          this.editForm["detached"] = [];
        if (this.editForm["exclude-global-prep-cmd"] === undefined)
          this.editForm["exclude-global-prep-cmd"] = false;
        if (this.editForm["elevated"] === undefined && this.platform === 'windows') {
          this.editForm["elevated"] = false;
        }
        if (this.editForm["auto-detach"] === undefined) {
          this.editForm["auto-detach"] = true;
        }
        if (this.editForm["wait-all"] === undefined) {
          this.editForm["wait-all"] = true;
        }
        if (this.editForm["exit-timeout"] === undefined) {
          this.editForm["exit-timeout"] = 5;
        }
        this.showEditForm = true;
      },
      showDeleteForm(id) {
        let resp = confirm(
          "Are you sure to delete " + this.apps[id].name + "?"
        );
        if (resp) {
          fetch("./api/apps/" + id, {
            method: "DELETE",
            headers: { 
              "Content-Type": "application/json" 
            },
          }).then((r) => {
            if (r.status === 200) document.location.reload();
          });
        }
      },
      addPrepCmd() {
        let template = {
          do: "",
          undo: ""
        };

        if (this.platform === 'windows') {
          template = { ...template, elevated: false };
        }

        this.editForm["prep-cmd"].push(template);
      },
      showCoverFinder($event) {
        this.coverCandidates = [];
        this.coverSearching = true;
        const ref = this.$refs.coverFinderDropdown;
        if (!ref) {
          console.error("Ref not found!");
          return;
        }
        this.coverFinderDropdown = Dropdown.getInstance(ref);
        if (!this.coverFinderDropdown) {
          this.coverFinderDropdown = new Dropdown(ref);
          if (!this.coverFinderDropdown) {
            return;
          }
        }
        this.coverFinderDropdown.show();
        function getSearchBucket(name) {
          let bucket = name.substring(0, Math.min(name.length, 2)).toLowerCase().replaceAll(/[^a-z\d]/g, '');
          if (!bucket) {
            return '@';
          }
          return bucket;
        }

        function searchCovers(name) {
          if (!name) {
            return Promise.resolve([]);
          }
          let searchName = name.replaceAll(/\s+/g, '.').toLowerCase();

          // Use raw.githubusercontent.com to avoid CORS issues as we migrate the CNAME
          let dbUrl = "https://raw.githubusercontent.com/LizardByte/GameDB/gh-pages";
          let bucket = getSearchBucket(name);
          return fetch(`${dbUrl}/buckets/${bucket}.json`).then(function (r) {
            if (!r.ok) throw new Error("Failed to search covers");
            return r.json();
          }).then(maps => Promise.all(Object.keys(maps).map(id => {
            let item = maps[id];
            if (item.name.replaceAll(/\s+/g, '.').toLowerCase().startsWith(searchName)) {
              return fetch(`${dbUrl}/games/${id}.json`).then(function (r) {
                return r.json();
              }).catch(() => null);
            }
            return null;
          }).filter(item => item)))
            .then(results => results
              .filter(item => item && item.cover && item.cover.url)
              .map(game => {
                const thumb = game.cover.url;
                const dotIndex = thumb.lastIndexOf('.');
                const slashIndex = thumb.lastIndexOf('/');
                if (dotIndex < 0 || slashIndex < 0) {
                  return null;
                }
                const slug = thumb.substring(slashIndex + 1, dotIndex);
                return {
                  name: game.name,
                  key: `igdb_${game.id}`,
                  url: `https://images.igdb.com/igdb/image/upload/t_cover_big/${slug}.jpg`,
                  saveUrl: `https://images.igdb.com/igdb/image/upload/t_cover_big_2x/${slug}.png`,
                }
              }).filter(item => item));
        }

        searchCovers(this.editForm["name"].toString())
          .then(list => this.coverCandidates = list)
          .finally(() => this.coverSearching = false);
      },
      closeCoverFinder() {
        const ref = this.$refs.coverFinderDropdown;
        if (!ref) {
          return;
        }
        const dropdown = this.coverFinderDropdown = Dropdown.getInstance(ref);
        if (!dropdown) {
          return;
        }
        dropdown.hide();
      },
      useCover(cover) {
        this.coverFinderBusy = true;
        fetch("./api/covers/upload", {
          method: "POST",
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            key: cover.key,
            url: cover.saveUrl,
          })
        }).then(r => {
          if (!r.ok) throw new Error("Failed to download covers");
          return r.json();
        }).then(body => this.editForm["image-path"] = body.path)
          .then(() => this.closeCoverFinder())
          .finally(() => this.coverFinderBusy = false);
      },
      save() {
        this.editForm["image-path"] = this.editForm["image-path"].toString().replace(/"/g, '');
        fetch("./api/apps", {
          method: "POST",
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(this.editForm),
        }).then((r) => {
          if (r.status === 200) document.location.reload();
        });
      },
    },
    computed: {
      nameSuggestions() {
        const q = ((this.editForm && this.editForm.name) || '').toLowerCase().trim();
        // Only installed games
        const list = this.playniteGames.filter(g => !!g.installed);
        // If no query, show none but keep dropdown shell visible for UX
        if (!q) return [];
        // Limit to 20 to keep UI snappy
        return list.filter(g => (g.name||'').toLowerCase().includes(q)).slice(0, 20);
      }
    }
  });

  app.directive('dropdown-show', {
    mounted: function (el, binding) {
      el.addEventListener('show.bs.dropdown', binding.value);
    }
  });

  initApp(app);
</script>
