<!DOCTYPE html>
<html lang="en" data-bs-theme="auto">

<head>
  <%- header %>
  <style>
    .section {
      padding: 1em;
      border: 1px solid #dee2e6;
      border-top: none;
    }
  </style>
</head>

<body id="app" v-cloak>
  <Navbar></Navbar>
  <div class="container">
    <h1 class="my-4">{{ $t('playnite.title') }}</h1>
    <p>{{ $t('playnite.desc') }}</p>

    <div class="alert alert-info" v-if="platform && platform !== 'windows'">
      {{ $t('playnite.only_windows') }}
    </div>

    <div v-if="platform === 'windows'">
      <!-- Status & Install -->
      <div class="card my-3">
        <div class="card-header">{{ $t('playnite.status_title') }}</div>
        <div class="card-body section">
          <div class="mb-3">
            <Checkbox v-model="playnite.playnite_enabled"
                      id="playnite_enabled"
                      :default="'disabled'"
                      :localePrefix="'playnite'"
                      :label="$t('playnite.integration_enabled')"
                      :desc="''"
            />
          </div>

          <div class="row g-3 align-items-center mb-2">
            <div class="col-auto"><b>{{ $t('playnite.status_overall') || 'Status' }}:</b></div>
            <div class="col-auto">
              <span class="badge" :class="statusBadgeClass">{{ statusText }}</span>
            </div>
          </div>
          <div class="row g-3 align-items-center mb-2" v-if="status.extensions_dir">
            <div class="col-auto"><b>{{ $t('playnite.extensions_dir') }}:</b></div>
            <div class="col-auto"><code>{{ status.extensions_dir }}</code></div>
          </div>

          <button class="btn btn-primary mt-2 me-2" @click="install" :disabled="installing">
            <span v-if="installing" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            <template v-if="status.installed">{{ $t('playnite.reinstall_button') || 'Reinstall Plugin' }}</template>
            <template v-else>{{ $t('playnite.install_button') }}</template>
          </button>
          <span class="text-success ms-2" v-if="installOk">{{ $t('playnite.install_success') }}</span>
          <span class="text-danger ms-2" v-if="installErr">{{ $t('playnite.install_error') }}<template v-if="installErrorMsg">: {{ installErrorMsg }}</template></span>
          <div class="alert alert-success my-3" v-if="saved && !restarted">
            <b>{{ $t('_common.success') }}</b> {{ $t('config.restart_note') }}
            <div class="mt-2">
              <button class="btn btn-success" @click="restart" v-if="saved && !restarted">{{ $t('_common.apply') }}</button>
            </div>
          </div>
          <div class="alert alert-success my-3" v-if="restarted">
            <b>{{ $t('_common.success') }}</b> {{ $t('config.restart_note') }}
          </div>
        </div>
      </div>

      <!-- Settings -->
      <div class="card my-3">
        <div class="card-header">{{ $t('playnite.settings_title') }}</div>
        <div class="card-body section">
          <div class="row mb-3">
            <div class="col-md-6">
              <Checkbox v-model="playnite.playnite_auto_sync"
                        id="playnite_auto_sync"
                        :default="'disabled'"
                        :localePrefix="'playnite'"
                        :label="$t('playnite.auto_sync')"
                        :desc="''"
              />
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="recent" class="form-label">{{ $t('playnite.recent_games') }}</label>
              <input id="recent" type="number" class="form-control" v-model.number="playnite.playnite_recent_games" min="0" />
              <div class="form-text">{{ $t('playnite.recent_games_desc') }}</div>
            </div>
            <div class="col-md-4">
              <label for="recentAge" class="form-label">{{ $t('playnite.recent_max_age_days') }}</label>
              <input id="recentAge" type="number" class="form-control" v-model.number="playnite.playnite_recent_max_age_days" min="0" />
              <div class="form-text">{{ $t('playnite.recent_max_age_days_desc') }}</div>
            </div>
            <div class="col-md-4">
              <label for="deleteAfter" class="form-label">{{ $t('playnite.delete_after_days') }}</label>
              <input id="deleteAfter" type="number" class="form-control" v-model.number="playnite.playnite_autosync_delete_after_days" min="0" />
              <div class="form-text">{{ $t('playnite.delete_after_days_desc') }}</div>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-8">
              <Checkbox v-model="playnite.playnite_autosync_require_replacement"
                        id="playnite_autosync_require_replacement"
                        :default="'enabled'"
                        :localePrefix="'playnite'"
                        :label="$t('playnite.require_replacement')"
                        :desc="$t('playnite.require_replacement_desc')"
              />
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="focusAttempts" class="form-label">{{ $t('playnite.focus_attempts') || 'Auto-focus attempts' }}</label>
              <input id="focusAttempts" type="number" class="form-control" v-model.number="playnite.playnite_focus_attempts" min="0" />
              <div class="form-text">{{ $t('playnite.focus_attempts_help') || 'Number of times to try to bring Playnite windows to the foreground when launching.' }}</div>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="focusTimeout" class="form-label">{{ $t('playnite.focus_timeout_secs') || 'Auto-focus timeout window (seconds)' }}</label>
              <input id="focusTimeout" type="number" class="form-control" v-model.number="playnite.playnite_focus_timeout_secs" min="0" />
              <div class="form-text">{{ $t('playnite.focus_timeout_secs_help') || 'How long auto-focus runs while re-applying focus (0 to disable).' }}</div>
            </div>
            <div class="col-md-6 d-flex align-items-end">
              <Checkbox v-model="playnite.playnite_focus_exit_on_first"
                        id="playnite_focus_exit_on_first"
                        :default="'disabled'"
                        :localePrefix="'playnite'"
                        :label="$t('playnite.focus_exit_on_first') || 'Exit on first confirmed focus'"
                        :desc="$t('playnite.focus_exit_on_first_help') || 'Stop auto-focus after first success; otherwise, re-apply until attempts or timeout elapse.'"
              />
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-8">
              <label for="cats" class="form-label">{{ $t('playnite.sync_categories') }}</label>
              <div class="input-group">
                <input id="cats" type="text" class="form-control" v-model="playnite.playnite_sync_categories" placeholder="Action;Favorites;RPG" @focus="loadPlayniteCategoriesIfNeeded" />
                <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false" @click="loadPlayniteCategoriesIfNeeded">
                  {{ selectedCategories.length ? (selectedCategories.length + ' selected') : 'Choose' }}
                </button>
                <div class="dropdown-menu dropdown-menu-end p-2" style="width: 320px; max-height: 280px; overflow-y: auto;">
                  <div class="mb-2">
                    <input type="text" class="form-control" :placeholder="$t('apps.add_playnite_search') || 'Search categories...'" v-model="catFilter">
                  </div>
                  <div v-if="categoriesLoading" class="text-center py-2">
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                  </div>
                  <template v-else>
                    <div v-if="filteredCategories.length === 0" class="text-muted small px-2 py-1">No categories</div>
                    <button v-for="c in filteredCategories" :key="c" class="dropdown-item d-flex align-items-center" @click.prevent="toggleCategory(c)">
                      <input class="form-check-input me-2" type="checkbox" :checked="selectedSet.has(c)">
                      <span class="flex-grow-1">{{ c }}</span>
                    </button>
                  </template>
                </div>
              </div>
              <div class="form-text">{{ $t('playnite.sync_categories_help') }}</div>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-8">
              <label for="exclude" class="form-label">{{ $t('playnite.exclude_games') || 'Exclude games from auto-sync' }}</label>
              <div class="input-group">
                <input id="exclude" type="text" class="form-control" v-model="playnite.playnite_exclude_games" placeholder="<GUID1>,<GUID2>" @focus="loadPlayniteGamesIfNeeded" />
                <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false" @click="loadPlayniteGamesIfNeeded">
                  {{ excludedIds.length ? (excludedIds.length + ' selected') : 'Choose' }}
                </button>
                <div class="dropdown-menu dropdown-menu-end p-2" style="width: 420px; max-height: 320px; overflow-y: auto;">
                  <div class="mb-2">
                    <input type="text" class="form-control" placeholder="Search games..." v-model="gameFilter">
                  </div>
                  <div v-if="gamesLoading" class="text-center py-2">
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                  </div>
                  <template v-else>
                    <div v-if="filteredGames.length === 0" class="text-muted small px-2 py-1">No games</div>
                    <button v-for="g in filteredGames" :key="g.id" class="dropdown-item d-flex align-items-center justify-content-between" @click.prevent="toggleExcluded(g)">
                      <div class="d-flex align-items-center">
                        <input class="form-check-input me-2" type="checkbox" :checked="excludedSet.has(g.id)">
                        <span class="text-truncate" style="max-width: 240px;">{{ g.name }}</span>
                      </div>
                      <span class="badge" :class="g.installed ? 'bg-success' : 'bg-secondary'">{{ g.installed ? 'Installed' : 'Not Installed' }}</span>
                    </button>
                  </template>
                </div>
              </div>
              <div class="form-text">Excluded games wonâ€™t be auto-synced from Playnite. Uses Playnite game IDs.</div>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-8">
              <label for="extdir" class="form-label">{{ $t('playnite.extensions_dir') }}</label>
              <input id="extdir" type="text" class="form-control" v-model="playnite.playnite_extensions_dir" />
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-8">
              <label for="installdir" class="form-label">{{ $t('playnite.install_dir') }}</label>
              <input id="installdir" type="text" class="form-control" v-model="playnite.playnite_install_dir" />
            </div>
          </div>

          <div class="mt-3">
            <button class="btn btn-primary me-2" @click="save" :disabled="saving">
              <span v-if="saving" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              {{ $t('_common.save') }}
            </button>
            <span class="text-success" v-if="saved">{{ $t('playnite.save_success') }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>

<script type="module">
  import { createApp, computed } from 'vue'
  import { initApp } from './init'
  import Navbar from './Navbar.vue'
  import Checkbox from './Checkbox.vue'

  const defaults = {
    playnite_enabled: 'disabled',
    playnite_auto_sync: 'disabled',
    playnite_recent_games: 20,
    playnite_recent_max_age_days: 0,
    playnite_autosync_delete_after_days: 0,
    playnite_autosync_require_replacement: 'enabled',
    playnite_focus_attempts: 3,
    playnite_focus_timeout_secs: 15,
    playnite_focus_exit_on_first: 'disabled',
    playnite_sync_categories: '',
    playnite_exclude_games: '',
    playnite_install_dir: '',
    playnite_extensions_dir: '',
  }

  const app = createApp({
    components: { Navbar, Checkbox },
    data() {
      return {
        platform: '',
        currentConfig: {},
        playnite: JSON.parse(JSON.stringify(defaults)),
        status: { enabled: false, active: false, installed: false, extensions_dir: '', session_required: false, playnite_running: false },
        saving: false,
        saved: false,
        restarted: false,
        installing: false,
        installOk: false,
        installErr: false,
        installErrorMsg: '',
        availableCategories: [],
        categoriesLoading: false,
        catFilter: '',
        // Exclusions UI state
        availableGames: [],
        gamesLoading: false,
        gameFilter: '',
      }
    },
    provide() {
      return { platform: computed(() => this.platform) }
    },
    created() {
      this.refreshConfig()
    },
    methods: {
      async refreshConfig() {
        try {
          const cfg = await fetch('./api/config').then(r => r.json())
          this.platform = cfg.platform || ''
          // Keep a copy of the full current config to merge on save
          this.currentConfig = JSON.parse(JSON.stringify(cfg))
          // load keys if present, else use defaults
          for (const k of Object.keys(defaults)) {
            if (cfg[k] !== undefined) this.playnite[k] = cfg[k]
          }
          // Only on Windows do we query Playnite status/APIs
          if (this.platform === 'windows') {
            await this.refreshStatus()
          }
        } catch (e) { console.error(e) }
      },
      async refreshStatus() {
        if (this.platform !== 'windows') return
        try {
          const st = await fetch('./api/playnite/status').then(r => r.json())
          this.status = st
        } catch (e) { console.error(e) }
      },
      async loadPlayniteCategoriesIfNeeded() {
        if (this.platform !== 'windows') return
        if (this.categoriesLoading || this.availableCategories.length) return
        this.categoriesLoading = true
        try {
          const cats = await fetch('./api/playnite/categories').then(r => r.json())
          if (Array.isArray(cats) && cats.length) {
            this.availableCategories = cats.slice().sort((a,b)=>String(a).localeCompare(String(b)))
          } else {
            // Fallback: derive categories from games list if categories are not available
            const games = await fetch('./api/playnite/games').then(r => r.json())
            this.availableGames = games || []
            const set = new Set()
            for (const g of (games || [])) {
              for (const c of (g.categories || [])) {
                if (c && typeof c === 'string') set.add(c)
              }
            }
            this.availableCategories = Array.from(set).sort((a,b)=>a.localeCompare(b))
          }
        } catch (e) { console.error(e) }
        this.categoriesLoading = false
      },
      async loadPlayniteGamesIfNeeded() {
        if (this.platform !== 'windows') return
        if (this.gamesLoading || this.availableGames.length) return
        this.gamesLoading = true
        try {
          const games = await fetch('./api/playnite/games').then(r => r.json())
          this.availableGames = games || []
        } catch (e) { console.error(e) }
        this.gamesLoading = false
      },
      toggleCategory(cat) {
        const set = new Set(this.selectedCategories)
        if (set.has(cat)) set.delete(cat); else set.add(cat)
        this.playnite.playnite_sync_categories = Array.from(set).join(';')
      },
      toggleExcluded(game) {
        const ids = new Set(this.excludedIds)
        if (ids.has(game.id)) ids.delete(game.id); else ids.add(game.id)
        this.playnite.playnite_exclude_games = Array.from(ids).join(',')
      },
      async save() {
        this.saving = this.saved = false
        // Merge with existing config so we don't wipe unrelated keys.
        const merged = {}
        // Preserve existing keys except UI-only ones
        for (const [k, v] of Object.entries(this.currentConfig || {})) {
          if (k === 'platform' || k === 'version' || k === 'status') continue
          merged[k] = v
        }
        // Overwrite Playnite keys with current UI values (even if equal to defaults)
        for (const k of Object.keys(defaults)) {
          merged[k] = this.playnite[k]
        }
        try {
          const r = await fetch('./api/config', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(merged) })
          if (r.status === 200) {
            this.saved = true
          }
        } catch (e) { console.error(e) }
        this.saving = false
      },
      async install() {
        this.installing = true
        this.installOk = false
        this.installErr = false
        this.installErrorMsg = ''
        try {
          const r = await fetch('./api/playnite/install', { method: 'POST', headers: {'Content-Type': 'application/json'} })
          let body = null
          try { body = await r.json() } catch {}
          const ok = r.ok && body && body.status === true
          if (ok) {
            this.installOk = true
            await this.refreshStatus()
          } else {
            this.installErr = true
            this.installErrorMsg = body && body.error ? body.error : (r.statusText || 'Unknown error')
          }
        } catch (e) {
          this.installErr = true
          this.installErrorMsg = (e && e.message) ? e.message : ''
        }
        this.installing = false
      },
      async restart() {
        try {
          this.restarted = true
          await fetch('./api/restart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
          })
        } catch (e) {
          console.error(e)
          this.restarted = false
        }
      }
    },
    computed: {
      statusText() {
        const st = this.status || {}
        if (st.enabled === false) return this.$t('playnite.status_disabled') || 'Disabled'
        if (st.active) return this.$t('playnite.status_connected')
        if (st.session_required) return this.$t('playnite.status_desktop_required') || 'Desktop Session Required'
        if (st.installed === false) return this.$t('playnite.status_uninstalled') || 'Uninstalled'
        if (st.playnite_running === false) return this.$t('playnite.status_not_running') || 'Playnite not running'
        // If installed and Playnite is running but not active, likely waiting for the plugin to connect
        if (st.installed === true && st.playnite_running === true && !st.active) return this.$t('playnite.status_waiting') || 'Waiting for plugin'
        // Fallback
        return this.$t('_common.unknown') || 'Unknown'
      },
      statusBadgeClass() {
        const st = this.status || {}
        if (st.enabled === false) return 'bg-secondary'
        if (st.active) return 'bg-success'
        if (st.session_required) return 'bg-warning text-dark'
        if (st.installed === false) return 'bg-secondary'
        if (st.playnite_running === false) return 'bg-danger'
        if (st.installed === true && st.playnite_running === true && !st.active) return 'bg-warning text-dark'
        return 'bg-secondary'
      },
      selectedCategories() {
        const raw = this.playnite.playnite_sync_categories || ''
        return raw.split(';').map(s=>s.trim()).filter(Boolean)
      },
      selectedSet() {
        return new Set(this.selectedCategories)
      },
      filteredCategories() {
        const q = (this.catFilter || '').toLowerCase()
        if (!q) return this.availableCategories
        return this.availableCategories.filter(c => c.toLowerCase().includes(q))
      },
      excludedIds() {
        const raw = this.playnite.playnite_exclude_games || ''
        return raw.split(',').map(s=>s.trim()).filter(Boolean)
      },
      excludedSet() {
        return new Set(this.excludedIds)
      },
      filteredGames() {
        // Only show installed games
        let list = (this.availableGames || []).filter(g => !!g.installed)
        const q = (this.gameFilter || '').toLowerCase()
        if (q) list = list.filter(g => (g.name||'').toLowerCase().includes(q))
        // sort: installed first, then name
        return list.slice().sort((a,b)=>{
          if (!!a.installed !== !!b.installed) return a.installed ? -1 : 1
          return (a.name||'').localeCompare(b.name||'')
        })
      }
    }
  })

  initApp(app)
</script>
