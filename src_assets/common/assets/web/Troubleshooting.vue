<template>
  <div class="container">
    <h1 class="my-4">{{ $t('troubleshooting.troubleshooting') }}</h1>
    <!-- Force Close App -->
    <div class="card p-2 my-4">
      <div class="card-body">
        <h2 id="close_apps">{{ $t('troubleshooting.force_close') }}</h2>
        <br>
        <p>{{ $t('troubleshooting.force_close_desc') }}</p>
        <div class="alert alert-success" v-if="closeAppStatus === true">
          {{ $t('troubleshooting.force_close_success') }}
        </div>
        <div class="alert alert-danger" v-if="closeAppStatus === false">
          {{ $t('troubleshooting.force_close_error') }}
        </div>
        <div>
          <button class="btn btn-warning" :disabled="closeAppPressed" @click="closeApp">
            {{ $t('troubleshooting.force_close') }}
          </button>
        </div>
      </div>
    </div>
    <!-- Restart Sunshine -->
    <div class="card p-2 my-4">
      <div class="card-body">
        <h2 id="restart">{{ $t('troubleshooting.restart_sunshine') }}</h2>
        <br>
        <p>{{ $t('troubleshooting.restart_sunshine_desc') }}</p>
        <div class="alert alert-success" v-if="restartPressed === true">
          {{ $t('troubleshooting.restart_sunshine_success') }}
        </div>
        <div>
          <button class="btn btn-warning" :disabled="restartPressed" @click="restart">
            {{ $t('troubleshooting.restart_sunshine') }}
          </button>
        </div>
      </div>
    </div>
    <!-- Reset persistent display device settings -->
    <div class="card p-2 my-4" v-if="platform === 'windows'">
      <div class="card-body">
        <h2 id="dd_reset">{{ $t('troubleshooting.dd_reset') }}</h2>
        <br>
        <p style="white-space: pre-line">{{ $t('troubleshooting.dd_reset_desc') }}</p>
        <div class="alert alert-success" v-if="ddResetStatus === true">
          {{ $t('troubleshooting.dd_reset_success') }}
        </div>
        <div class="alert alert-danger" v-if="ddResetStatus === false">
          {{ $t('troubleshooting.dd_reset_error') }}
        </div>
        <div>
          <button class="btn btn-warning" :disabled="ddResetPressed" @click="ddResetPersistence">
            {{ $t('troubleshooting.dd_reset') }}
          </button>
        </div>
      </div>
    </div>
    <!-- Unpair Clients -->
    <div class="card my-4">
      <div class="card-body">
        <div class="p-2">
          <div class="d-flex justify-content-end align-items-center">
            <h2 id="unpair" class="text-center me-auto">{{ $t('troubleshooting.unpair_title') }}</h2>
            <button class="btn btn-danger" :disabled="unpairAllPressed" @click="unpairAll">
              {{ $t('troubleshooting.unpair_all') }}
            </button>
          </div>
          <br />
          <p class="mb-0">{{ $t('troubleshooting.unpair_desc') }}</p>
          <div id="apply-alert" class="alert alert-success d-flex align-items-center mt-3" :style="{ 'display': (showApplyMessage ? 'flex !important': 'none !important') }">
            <div class="me-2"><b>{{ $t('_common.success') }}</b> {{ $t('troubleshooting.unpair_single_success') }}</div>
            <button class="btn btn-success ms-auto apply" @click="clickedApplyBanner">{{ $t('_common.dismiss') }}</button>
          </div>
          <div class="alert alert-success mt-3" v-if="unpairAllStatus === true">
            {{ $t('troubleshooting.unpair_all_success') }}
          </div>
          <div class="alert alert-danger mt-3" v-if="unpairAllStatus === false">
            {{ $t('troubleshooting.unpair_all_error') }}
          </div>
        </div>
      </div>
      <ul id="client-list" class="list-group list-group-flush list-group-item-light" v-if="clients && clients.length > 0">
        <div v-for="client in clients" :key="client.uuid" class="list-group-item d-flex">
          <div class="p-2 flex-grow-1">{{ client.name !== "" ? client.name : $t('troubleshooting.unpair_single_unknown') }}</div>
          <div class="me-2 ms-auto btn btn-danger" @click="unpairSingle(client.uuid)"><i class="fas fa-trash"></i></div>
        </div>
      </ul>
      <ul v-else class="list-group list-group-flush list-group-item-light">
        <div class="list-group-item p-3 text-center"><em>{{ $t('troubleshooting.unpair_single_no_devices') }}</em></div>
      </ul>

    </div>
    <!-- Logs -->
    <div class="card p-2 my-4">
      <div class="card-body">
        <h2 id="logs">{{ $t('troubleshooting.logs') }}</h2>
        <br>
        <div class="d-flex justify-content-between align-items-baseline py-2">
          <p>{{ $t('troubleshooting.logs_desc') }}</p>
          <input type="text" class="form-control" v-model="logFilter" :placeholder="$t('troubleshooting.logs_find')" style="width: 300px">
        </div>
        <div>
          <div class="troubleshooting-logs">
            <button class="copy-icon"><i class="fas fa-copy " @click="copyLogs"></i></button>{{actualLogs}}
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, onBeforeUnmount } from 'vue'
import { useConfigStore } from './stores/config.js'

const store = useConfigStore()
const platform = computed(() => store.config.value?.platform || '')

const clients = ref([])
const closeAppPressed = ref(false)
const closeAppStatus = ref(null)
const ddResetPressed = ref(false)
const ddResetStatus = ref(null)
const logs = ref('Loading...')
const logFilter = ref(null)
let logInterval = null
const restartPressed = ref(false)
const showApplyMessage = ref(false)
const unpairAllPressed = ref(false)
const unpairAllStatus = ref(null)

const actualLogs = computed(() => {
  if (!logFilter.value) return logs.value
  let lines = logs.value.split('\n')
  lines = lines.filter(x => x.indexOf(logFilter.value) !== -1)
  return lines.join('\n')
})

function refreshLogs(){
  fetch('./api/logs')
    .then(r => r.text())
    .then(r => { logs.value = r })
}

function closeApp(){
  closeAppPressed.value = true
  fetch('./api/apps/close',{ method:'POST', headers:{ 'Content-Type':'application/json' } })
    .then(r => r.json())
    .then(r => {
      closeAppPressed.value = false
      closeAppStatus.value = r.status
      setTimeout(()=>{ closeAppStatus.value = null }, 5000)
    })
}

function unpairAll(){
  unpairAllPressed.value = true
  fetch('./api/clients/unpair-all',{ method:'POST', headers:{ 'Content-Type':'application/json' } })
    .then(r => r.json())
    .then(r => {
      unpairAllPressed.value = false
      unpairAllStatus.value = r.status
      setTimeout(()=>{ unpairAllStatus.value = null }, 5000)
      refreshClients()
    })
}

function unpairSingle(uuid){
  fetch('./api/clients/unpair',{ method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ uuid }) })
    .then(()=>{ showApplyMessage.value = true; refreshClients() })
}

function refreshClients(){
  fetch('./api/clients/list')
    .then(r => r.json())
    .then(response => {
      if (response.status === true && response.named_certs && response.named_certs.length){
        clients.value = response.named_certs.sort((a,b)=> (a.name.toLowerCase() > b.name.toLowerCase() || a.name === '' ? 1 : -1))
      } else {
        clients.value = []
      }
    })
}

function clickedApplyBanner(){ showApplyMessage.value = false }

function copyLogs(){ navigator.clipboard.writeText(actualLogs.value) }

function restart(){
  restartPressed.value = true
  setTimeout(()=>{ restartPressed.value = false }, 5000)
  fetch('./api/restart',{ method:'POST', headers:{ 'Content-Type':'application/json' } })
}

function ddResetPersistence(){
  ddResetPressed.value = true
  fetch('/api/reset-display-device-persistence',{ method:'POST', headers:{ 'Content-Type':'application/json' } })
    .then(r => r.json())
    .then(r => {
      ddResetPressed.value = false
      ddResetStatus.value = r.status
      setTimeout(()=>{ ddResetStatus.value = null }, 5000)
    })
}

onMounted(()=>{
  // If store has no config yet, use the store helper to fetch it so platform is available
  if(!store.config.value){
    store.fetchConfig().catch(()=>{})
  }
  logInterval = setInterval(()=> refreshLogs(), 5000)
  refreshLogs()
  refreshClients()
})

onBeforeUnmount(()=>{ if(logInterval) clearInterval(logInterval) })
</script>

<style scoped>
.troubleshooting-logs {
  white-space: pre;
  font-family: monospace;
  overflow: auto;
  max-height: 500px;
  min-height: 500px;
  font-size: 16px;
  position: relative;
}

.copy-icon {
  position: absolute;
  top: 8px;
  right: 8px;
  padding: 8px;
  cursor: pointer;
  color: rgba(0, 0, 0, 1);
  appearance: none;
  border: none;
  background: none;
}

.copy-icon:hover {
  color: rgba(0, 0, 0, 0.75);
}

.copy-icon:active {
  color: rgba(0, 0, 0, 1);
}
</style>
